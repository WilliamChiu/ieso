{"ast":null,"code":"function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport bcrypt from 'bcrypt';\nimport { MongoClient } from 'mongodb';\nimport css from 'next-auth/dist/css';\nconst uri = \"mongodb://mongo:27017\";\nconst SALT_ROUNDS = 12;\nconst client = new MongoClient(uri);\n\nconst handleGet = async (res, error) => {\n  res.statusCode = 200;\n  res.setHeader('Content-Type', 'text/html');\n  res.send(`\n    <!DOCTYPE html>\n      <head>\n        <style type=\"text/css\">${css()}</style>\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n      </head>\n      <body>\n        <div class=\"page\">\n          <div class='signin'>\n            ${error ? `<div className='error'>\n                <p>That username has already been taken</p>\n              </div>` : ``}\n            <div class='provider'>\n              <form method='post' action='/api/auth/register'>\n                <label>\n                  Username\n                  <input name='username' type='text'/>\n                </label>\n                <label>\n                  Password\n                  <input name='password' type='password'/>\n                </label>\n                <button type='submit'>Register</button>\n              </form>\n            </div>\n          </div>\n        </div>\n      </body>\n    </html>\n  `);\n};\n\nconst handlePost = async (username, password, callbackUrl, res) => {\n  await client.connect();\n  const database = client.db(\"accounts\");\n  const collection = database.collection(\"users\");\n  let hash = await bcrypt.hash(password, SALT_ROUNDS);\n  const user = {\n    username,\n    hash\n  };\n\n  try {\n    const result = await collection.insertOne(user);\n    console.log(callbackUrl);\n    res.statusCode = 201;\n    res.setHeader('Content-Type', 'application/json');\n    res.redirect(callbackUrl);\n  } catch (e) {\n    console.log(e);\n    res.statusCode = 409;\n    res.setHeader('Content-Type', 'application/json');\n    res.end(JSON.stringify(e));\n  }\n};\n\nexport default (async (_ref, res) => {\n  let {\n    body: {\n      username,\n      password\n    },\n    method,\n    query: {\n      callbackUrl\n    }\n  } = _ref,\n      rest = _objectWithoutProperties(_ref, [\"body\", \"method\", \"query\"]);\n\n  console.log(rest);\n\n  if (method !== \"POST\" && method !== \"GET\") {\n    res.statusCode = 405;\n    res.setHeader('Content-Type', 'application/json');\n    res.end(JSON.stringify({\n      message: \"Register only accepts GET or POST requests\"\n    }));\n  } else if (method === \"GET\") await handleGet(res, false);else await handlePost(username, password, callbackUrl, res);\n});","map":{"version":3,"sources":["/usr/src/app/pages/api/auth/register.js"],"names":["bcrypt","MongoClient","css","uri","SALT_ROUNDS","client","handleGet","res","error","statusCode","setHeader","send","handlePost","username","password","callbackUrl","connect","database","db","collection","hash","user","result","insertOne","console","log","redirect","e","end","JSON","stringify","body","method","query","rest","message"],"mappings":";;;;AAAA,OAAOA,MAAP,MAAmB,QAAnB;AACA,SAASC,WAAT,QAA4B,SAA5B;AACA,OAAOC,GAAP,MAAgB,oBAAhB;AAEA,MAAMC,GAAG,GAAG,uBAAZ;AAEA,MAAMC,WAAW,GAAG,EAApB;AAEA,MAAMC,MAAM,GAAG,IAAIJ,WAAJ,CAAgBE,GAAhB,CAAf;;AAEA,MAAMG,SAAS,GAAG,OAAOC,GAAP,EAAYC,KAAZ,KAAsB;AACtCD,EAAAA,GAAG,CAACE,UAAJ,GAAiB,GAAjB;AACAF,EAAAA,GAAG,CAACG,SAAJ,CAAc,cAAd,EAA6B,WAA7B;AACAH,EAAAA,GAAG,CAACI,IAAJ,CAAU;;;iCAGqBT,GAAG,EAAG;;;;;;cAMzBM,KAAK,GACJ;;qBADI,GAGM,EACZ;;;;;;;;;;;;;;;;;;GAbX;AAgCD,CAnCD;;AAqCA,MAAMI,UAAU,GAAG,OAAOC,QAAP,EAAiBC,QAAjB,EAA2BC,WAA3B,EAAwCR,GAAxC,KAAgD;AACjE,QAAMF,MAAM,CAACW,OAAP,EAAN;AACA,QAAMC,QAAQ,GAAGZ,MAAM,CAACa,EAAP,CAAU,UAAV,CAAjB;AACA,QAAMC,UAAU,GAAGF,QAAQ,CAACE,UAAT,CAAoB,OAApB,CAAnB;AAEA,MAAIC,IAAI,GAAG,MAAMpB,MAAM,CAACoB,IAAP,CAAYN,QAAZ,EAAsBV,WAAtB,CAAjB;AAEA,QAAMiB,IAAI,GAAG;AAAER,IAAAA,QAAF;AAAYO,IAAAA;AAAZ,GAAb;;AAEA,MAAI;AACF,UAAME,MAAM,GAAG,MAAMH,UAAU,CAACI,SAAX,CAAqBF,IAArB,CAArB;AACAG,IAAAA,OAAO,CAACC,GAAR,CAAYV,WAAZ;AACAR,IAAAA,GAAG,CAACE,UAAJ,GAAiB,GAAjB;AACAF,IAAAA,GAAG,CAACG,SAAJ,CAAc,cAAd,EAA8B,kBAA9B;AACAH,IAAAA,GAAG,CAACmB,QAAJ,CAAaX,WAAb;AACD,GAND,CAME,OAAOY,CAAP,EAAU;AACVH,IAAAA,OAAO,CAACC,GAAR,CAAYE,CAAZ;AACApB,IAAAA,GAAG,CAACE,UAAJ,GAAiB,GAAjB;AACAF,IAAAA,GAAG,CAACG,SAAJ,CAAc,cAAd,EAA8B,kBAA9B;AACAH,IAAAA,GAAG,CAACqB,GAAJ,CAAQC,IAAI,CAACC,SAAL,CAAeH,CAAf,CAAR;AACD;AAEF,CAtBD;;AAwBA,gBAAe,aAA4EpB,GAA5E,KAAoF;AAAA,MAA7E;AAACwB,IAAAA,IAAI,EAAE;AAAClB,MAAAA,QAAD;AAAWC,MAAAA;AAAX,KAAP;AAA6BkB,IAAAA,MAA7B;AAAqCC,IAAAA,KAAK,EAAE;AAAClB,MAAAA;AAAD;AAA5C,GAA6E;AAAA,MAAfmB,IAAe;;AACjGV,EAAAA,OAAO,CAACC,GAAR,CAAYS,IAAZ;;AACA,MAAIF,MAAM,KAAK,MAAX,IAAqBA,MAAM,KAAK,KAApC,EAA2C;AACzCzB,IAAAA,GAAG,CAACE,UAAJ,GAAiB,GAAjB;AACAF,IAAAA,GAAG,CAACG,SAAJ,CAAc,cAAd,EAA8B,kBAA9B;AACAH,IAAAA,GAAG,CAACqB,GAAJ,CAAQC,IAAI,CAACC,SAAL,CAAe;AAACK,MAAAA,OAAO,EAAE;AAAV,KAAf,CAAR;AACD,GAJD,MAKK,IAAIH,MAAM,KAAK,KAAf,EAAsB,MAAM1B,SAAS,CAACC,GAAD,EAAM,KAAN,CAAf,CAAtB,KACA,MAAMK,UAAU,CAACC,QAAD,EAAWC,QAAX,EAAqBC,WAArB,EAAkCR,GAAlC,CAAhB;AACN,CATD","sourcesContent":["import bcrypt from 'bcrypt'\nimport { MongoClient } from 'mongodb'\nimport css from 'next-auth/dist/css'\n\nconst uri = \"mongodb://mongo:27017\";\n\nconst SALT_ROUNDS = 12\n\nconst client = new MongoClient(uri);\n\nconst handleGet = async (res, error) => {\n  res.statusCode = 200\n  res.setHeader('Content-Type','text/html')\n  res.send(`\n    <!DOCTYPE html>\n      <head>\n        <style type=\"text/css\">${css()}</style>\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n      </head>\n      <body>\n        <div class=\"page\">\n          <div class='signin'>\n            ${error ?\n              `<div className='error'>\n                <p>That username has already been taken</p>\n              </div>` : ``\n            }\n            <div class='provider'>\n              <form method='post' action='/api/auth/register'>\n                <label>\n                  Username\n                  <input name='username' type='text'/>\n                </label>\n                <label>\n                  Password\n                  <input name='password' type='password'/>\n                </label>\n                <button type='submit'>Register</button>\n              </form>\n            </div>\n          </div>\n        </div>\n      </body>\n    </html>\n  `)\n}\n\nconst handlePost = async (username, password, callbackUrl, res) => {\n  await client.connect()\n  const database = client.db(\"accounts\")\n  const collection = database.collection(\"users\")\n\n  let hash = await bcrypt.hash(password, SALT_ROUNDS)\n\n  const user = { username, hash }\n\n  try {\n    const result = await collection.insertOne(user)\n    console.log(callbackUrl)\n    res.statusCode = 201\n    res.setHeader('Content-Type', 'application/json')\n    res.redirect(callbackUrl)\n  } catch (e) {\n    console.log(e)\n    res.statusCode = 409\n    res.setHeader('Content-Type', 'application/json')\n    res.end(JSON.stringify(e))\n  }\n\n}\n\nexport default async ({body: {username, password}, method, query: {callbackUrl}, ...rest}, res) => {\n  console.log(rest)\n  if (method !== \"POST\" && method !== \"GET\") {\n    res.statusCode = 405\n    res.setHeader('Content-Type', 'application/json')\n    res.end(JSON.stringify({message: \"Register only accepts GET or POST requests\"}))\n  }\n  else if (method === \"GET\") await handleGet(res, false)\n  else await handlePost(username, password, callbackUrl, res)\n}"]},"metadata":{},"sourceType":"module"}